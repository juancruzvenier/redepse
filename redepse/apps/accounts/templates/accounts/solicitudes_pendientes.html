{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Solicitudes Pendientes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'accounts/css/admin.css' %}" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <img src="{% static 'accounts/img/logo.jpeg' %}" alt="Logo" />
          <h2>REDEPSE</h2>
        </div>

        <nav>
          <ul>
            <li>
              <a
                href="{% url 'accounts:admin_dashboard' %}"
                class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}"
              >
                Escuelas Registradas
              </a>
            </li>
            <li>
              <a
                href="{% url 'accounts:solicitudes_pendientes' %}"
                class="sidebar-link {% if request.resolver_match.url_name == 'solicitudes_pendientes' %}active{% endif %}"
              >
                Solicitudes Pendientes
              </a>
            </li>
            <li><a href="{% url 'accounts:entrenadores_registrados' %}" class="sidebar-link">Entrenadores</a></li>
            <li><a href="#" class="sidebar-link" onclick="abrirModalCapacitacion(event)">Capacitaciones</a></li>
          </ul>
        </nav>

        <div class="logout">
          <a href="{% url 'accounts:logout' %}">Cerrar sesión</a>
        </div>
      </aside>

      <!-- Contenido principal -->
      <main class="content">
        <header>
          <h1>Administrador</h1>
        </header>

        <section class="table-section">
          <div class="table-header">
            <h2>Solicitudes Pendientes</h2>
            <div class="filters">
              <input type="text" placeholder="Buscar por escuela" />
              <input type="text" placeholder="Buscar por municipio" />
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Escuela</th>
                <th>Localidad</th>
                <th>Tel. Escuela</th>
                <th>Tel. Responsable</th>
                <th>Correo</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for e in escuelas %}
              <tr>
                <td>{{ e.nombre_esc }}</td>
                <td>{{ e.localidad }}</td>
                <td>{{ e.telefono1 }}</td>
                <td>{{ e.telefono2|default:"—" }}</td>
                <td>{{ e.email }}</td>
                <td>
                  <a
                    href="{% url 'accounts:detalle_escuela' e.id_esc %}?from=solicitudes_pendientes"
                    class="view-btn"
                    >Ver datos</a
                  >
                  <button
                    class="btn-aprobar"
                    onclick="abrirModal('aprobar', '{{ e.id_esc }}', '{{ e.email }}')"
                  >
                    Aprobar
                  </button>
                  <button
                    class="btn-denegar"
                    onclick="abrirModal('denegar', '{{ e.id_esc }}', '{{ e.email }}')"
                  >
                    Denegar
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  No hay solicitudes pendientes.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      </main>
    </div>

    <!-- Modal -->
    <div id="modalAccion" class="modal" style="display: none">
      <div class="modal-content">
        <h3 id="modalTitulo">Acción</h3>
        <textarea
          id="mensajeObservacion"
          placeholder="Escribe tus observaciones..."
          rows="4"
        ></textarea>
        <div class="modal-buttons">
          <button id="btnConfirmarAccion" class="btn-aprobar">Confirmar</button>
          <button onclick="cerrarModal()" class="btn-denegar">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Notificación (fuera de los scripts) -->
    <div id="notificacion" class="notificacion" style="display: none">
      <p id="notificacion-texto"></p>
    </div>

    <script>
      /* --- FILTROS --- */
      document.addEventListener("DOMContentLoaded", function () {
        const inputEscuela = document.querySelector(
          "input[placeholder='Buscar por escuela']"
        );
        const inputMunicipio = document.querySelector(
          "input[placeholder='Buscar por municipio']"
        );
        const filas = document.querySelectorAll("tbody tr");
        const tbody = document.querySelector("tbody");

        function filtrar() {
          const te = inputEscuela.value.trim().toLowerCase();
          const tm = inputMunicipio.value.trim().toLowerCase();
          let hay = false;

          filas.forEach((fila) => {
            const n = fila.cells[0].textContent.toLowerCase();
            const l = fila.cells[1].textContent.toLowerCase();
            const ok = (!te || n.includes(te)) && (!tm || l.includes(tm));
            fila.style.display = ok ? "" : "none";
            if (ok) hay = true;
          });

          const msg = document.getElementById("sin-resultados");
          if (!hay) {
            if (!msg) {
              const m = document.createElement("tr");
              m.id = "sin-resultados";
              m.innerHTML = `<td colspan="6" style="text-align:center; color:#888;">No se encontraron escuelas</td>`;
              tbody.appendChild(m);
            }
          } else if (msg) {
            msg.remove();
          }
        }

        inputEscuela.addEventListener("input", filtrar);
        inputMunicipio.addEventListener("input", filtrar);
      });

      /* --- MODAL --- */
      let accionSeleccionada = "";
      let escuelaSeleccionada = null;
      let emailEscuela = "";

      function abrirModal(accion, id_esc, email) {
        accionSeleccionada = accion;
        escuelaSeleccionada = id_esc;
        emailEscuela = email;
        document.getElementById("modalTitulo").innerText =
          accion === "aprobar" ? "Aprobar escuela" : "Denegar escuela";
        document.getElementById("modalAccion").style.display = "flex";
      }

      function cerrarModal() {
        document.getElementById("modalAccion").style.display = "none";
        document.getElementById("mensajeObservacion").value = "";
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      /* --- NOTIFICACIÓN --- */
      function mostrarNotificacion(texto, tipo = "ok") {
        const box = document.getElementById("notificacion");
        const msg = document.getElementById("notificacion-texto");
        box.className = `notificacion ${tipo}`;
        msg.textContent = texto;
        box.style.display = "flex";
        setTimeout(() => {
          box.style.display = "none";
        }, 3000);
      }

      /* --- CONFIRMAR ACCIÓN --- */
      document
        .getElementById("btnConfirmarAccion")
        .addEventListener("click", async () => {
          const mensaje = document.getElementById("mensajeObservacion").value;

          const response = await fetch(
            "{% url 'accounts:gestionar_solicitud' %}",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({
                id_esc: escuelaSeleccionada,
                accion: accionSeleccionada,
                email: emailEscuela,
                mensaje: mensaje,
              }),
            }
          );

          if (response.ok) {
            mostrarNotificacion("✅ Solicitud procesada correctamente.", "ok");
            cerrarModal();
            setTimeout(() => location.reload(), 2000);
          } else {
            mostrarNotificacion("⚠️ Error al procesar la solicitud.", "error");
          }
        });
    </script>
    {% include 'accounts/includes/modal_capacitacion.html' %}

  </body>
</html>
