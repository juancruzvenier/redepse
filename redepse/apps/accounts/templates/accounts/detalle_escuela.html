{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalles de Escuela</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <link rel="stylesheet" href="{% static 'accounts/css/admin.css' %}" />
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="logo">
          <img src="{% static 'accounts/img/logo.jpeg' %}" alt="Logo" />
          <h2>REDEPSE</h2>
        </div>
        <nav>
          <ul>
            <li>
              <a
                href="{% url 'accounts:admin_dashboard' %}"
                class="sidebar-link {% if origen == 'admin_dashboard' %}active{% endif %}"
              >
                Escuelas Registradas
              </a>
            </li>
            <li>
              <a
                href="{% url 'accounts:solicitudes_pendientes' %}"
                class="sidebar-link {% if origen == 'solicitudes_pendientes' %}active{% endif %}"
              >
                Solicitudes Pendientes
              </a>
            </li>

            <li><a href="{% url 'accounts:entrenadores_registrados' %}" class="sidebar-link">Entrenadores</a></li>
            <li><a href="#" class="sidebar-link" onclick="abrirModalCapacitacion(event)">Capacitaciones</a></li>           
          </ul>
        </nav>
        <div class="logout">
          <a href="{% url 'accounts:logout' %}">Cerrar sesi√≥n</a>
        </div>
      </aside>

      <main class="content">
        <header>
          <h1>Administrador</h1>
        </header>

        <section class="school-details">
          <h2>{{ escuela.nombre_esc }}</h2>

          <div class="cards">
            <div
              class="card"
              onclick="marcarActiva(this); mostrarDatosGenerales()"
            >
              Datos Generales
            </div>
            <div
              class="card"
              onclick="marcarActiva(this); mostrarDocumentacion()"
            >
              Documentacion
            </div>
            <div
              class="card"
              onclick="marcarActiva(this); mostrarDisciplinas()"
            >
              Disciplinas
            </div>
            <div
              class="card"
              onclick="marcarActiva(this); mostrarEntrenadores()"
            >
              Entrenadores
            </div>
            <div class="card" onclick="marcarActiva(this); mostrarAlumnos()">
              Alumnos
            </div>
            <div class="card" onclick="marcarActiva(this); mostrarTutores()">
              Tutores
            </div>
          </div>

          <div id="info-container" class="info-container"></div>

          {% if origen == 'solicitudes_pendientes' %}
          <a href="{% url 'accounts:solicitudes_pendientes' %}" class="back-btn"
            >‚¨Ö Volver</a
          >
          {% else %}
          <a href="{% url 'accounts:admin_dashboard' %}" class="back-btn"
            >‚¨Ö Volver</a
          >
          {% endif %}
        </section>
      </main>
    </div>

    <script>
        function mostrarDatosGenerales() {
          const lat = "{{ escuela.latitud|floatformat:6 }}";
          const lng = "{{ escuela.longitud|floatformat:6 }}";
          const gmaps = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;



  const data = {
    nombre: "{{ escuela.nombre_esc }}",
    localidad: "{{ escuela.localidad }}",
    direccion: "{{ escuela.direccion }}",
    estado: "{{ escuela.estado }}",
    telefono1: "{{ escuela.telefono1 }}",
    telefono2: "{{ escuela.telefono2|default:'-' }}",
    email: "{{ escuela.email }}",
    lat, lng
  };

  let ubicacionHTML = "<p><strong>Ubicaci√≥n:</strong> No especificada</p>";
  if (lat && lng) {
    // 1. Preparamos las variables SOLO para la URL (cambiamos , por .)
    const latUrl = String(lat).replace(',', '.');
    const lngUrl = String(lng).replace(',', '.');

    ubicacionHTML = `
      <p><strong>Coordenadas:</strong> ${lat}, ${lng}</p>
      
      <p>
        <a href="https://www.google.com/maps?q=${latUrl},${lngUrl}" target="_blank" style="color:#0066ff; text-decoration:none;">
            Ver en Google Maps
        </a>
      </p>
      <div id="mapaDatos" class="mapa-datos"></div>
    `;
  }

  const html = `
    <div class="datos-generales">
      <h3>Datos Generales</h3>
      <p><strong>Nombre:</strong> ${data.nombre}</p>
      <p><strong>Localidad:</strong> ${data.localidad}</p>
      <p><strong>Direcci√≥n:</strong> ${data.direccion}</p>
      <p><strong>Estado:</strong> ${data.estado}</p>
      <p><strong>Tel. Escuela:</strong> ${data.telefono1}</p>
      <p><strong>Tel. Responsable:</strong> ${data.telefono2}</p>
      <p><strong>Correo:</strong> ${data.email}</p>
      ${ubicacionHTML}
    </div>
  `;

  const info = document.getElementById("info-container");
  info.innerHTML = html;
  info.style.display = "block";

  if (lat && lng) {
    setTimeout(() => initMapaDatos(lat, lng), 50);
  }
}
  let mapaDatos;
    function initMapaDatos(lat, lng) {
      // 1. Aseguramos que sea string y reemplazamos coma por punto
      const latStr = String(lat).replace(',', '.');
      const lngStr = String(lng).replace(',', '.');
      const latNum = parseFloat(latStr);
      const lngNum = parseFloat(lngStr);
    // const latNum = parseFloat(lat), lngNum = parseFloat(lng);
      if (isNaN(latNum) || isNaN(lngNum)) return;

      if (mapaDatos) {
        mapaDatos.remove();
      }
      mapaDatos = L.map('mapaDatos').setView([latNum, lngNum], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapaDatos);
      L.marker([latNum, lngNum]).addTo(mapaDatos);
    }
        function mostrarDocumentacion() {
            // Documentos de la escuela
            const documentos = [
              {% for doc in documentos %}
                {
                  tipo: "{{ doc.get_tipo_display|default:doc.tipo|escapejs }}",
                  // IMPORTANTE: |safe evita que se rompa la firma de R2 (& -> &amp;)
                  url: "{{ doc.documento.url|safe }}", 
                  nombre: "{{ doc.documento.name|default:'archivo'|escapejs }}"
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ];

            // Certificados de buena conducta de entrenadores
            const entrenadoresConducta = [
              {% for ent in entrenadores %}
                {% if ent.buena_conducta %}
                  {
                    nombre: "{{ ent.nombre|escapejs }} {{ ent.apellido|escapejs }}",
                    // IMPORTANTE: |safe aqu√≠ tambi√©n
                    url: "{{ ent.buena_conducta.url|safe }}",
                    archivo: "{{ ent.buena_conducta.name|default:'conducta.pdf'|escapejs }}"
                  }, // Dejamos la coma siempre, JS moderno lo tolera bien en arrays
                {% endif %}
              {% endfor %}
            ];

            let html = `<div class="documentacion"><h3>Documentaci√≥n</h3>`;

            // Secci√≥n documentos generales
            if (documentos.length === 0) {
              html += `<p>No hay documentaci√≥n cargada para esta escuela.</p>`;
            } else {
              html += `<ul>`;
              documentos.forEach(doc => {
                // Limpiamos el nombre para mostrar solo el archivo final
                const nombre = doc.nombre.split('/').pop();
                html += `<li><strong>${doc.tipo}:</strong> <a href="${doc.url}" target="_blank" rel="noopener noreferrer">üìÑ ${nombre}</a></li>`;
              });
              html += `</ul>`;
            }

            // Secci√≥n certificados de entrenadores
            if (entrenadoresConducta.length > 0) {
                html += `<h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">Certificados de Buena Conducta (Entrenadores)</h4>`;
                html += `<ul>`;
                entrenadoresConducta.forEach(ent => {
                    const nombreArchivo = ent.archivo.split('/').pop();
                    html += `<li><strong>${ent.nombre}:</strong> <a href="${ent.url}" target="_blank" rel="noopener noreferrer">üìÑ ${nombreArchivo}</a></li>`;
                });
                html += `</ul>`;
            } else {
                 html += `<h4 style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">Certificados de Entrenadores</h4>`;
                 html += `<p>No hay certificados cargados.</p>`;
            }

            html += `</div>`;

            const info = document.getElementById("info-container");
            info.innerHTML = html;
            info.style.display = "block";
        }

        function mostrarAlumnos() {
            const alumnos = [
              {% for alu in alumnos %}
                {
                  nombre: "{{ alu.nombre|escapejs }}",
                  apellido: "{{ alu.apellido|escapejs }}",
                  dni: "{{ alu.dni_alumno|escapejs }}",
                  fecha_nac: "{{ alu.fecha_nac|date:'d/m/Y' }}",
                  estado: "{{ alu.estado|default:'Activo'|escapejs }}"
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ];

            let html = "<h3>Alumnos</h3>";

            if (alumnos.length === 0) {
              html += "<p>No hay alumnos registrados para esta escuela.</p>";
            } else {
              html += `
                <table class='tabla-alumnos'>
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Apellido</th>
                      <th>DNI</th>
                      <th>Fecha Nac.</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              alumnos.forEach(a => {
                html += `
                  <tr>
                    <td>${a.nombre}</td>
                    <td>${a.apellido}</td>
                    <td>${a.dni}</td>
                    <td>${a.fecha_nac}</td>
                    <td>${a.estado}</td>
                  </tr>
                `;
              });
              html += "</tbody></table>";
            }

            const info = document.getElementById("info-container");
            info.innerHTML = html;
            info.style.display = "block";
        }

        function mostrarEntrenadores() {
          const entrenadores = [
            {% for ent in entrenadores %}
              {
                nombre: "{{ ent.nombre|escapejs }}",
                apellido: "{{ ent.apellido|escapejs }}",
                email: "{{ ent.email|escapejs }}",
                telefono1: "{{ ent.telefono1|default:'-'|escapejs }}",
                telefono2: "{{ ent.telefono2|default:'-'|escapejs }}"
              }{% if not forloop.last %},{% endif %}
            {% endfor %}
          ];

          let html = "<h3>Entrenadores</h3>";

          if (entrenadores.length === 0) {
            html += "<p>No hay entrenadores registrados para esta escuela.</p>";
          } else {
            html += `
              <table class="tabla-alumnos">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Email</th>
                    <th>Tel√©fono 1</th>
                    <th>Tel√©fono 2</th>
                  </tr>
                </thead>
                <tbody>
            `;
            entrenadores.forEach(e => {
              html += `
                <tr>
                  <td>${e.nombre}</td>
                  <td>${e.apellido}</td>
                  <td>${e.email}</td>
                  <td>${e.telefono1}</td>
                  <td>${e.telefono2}</td>
                </tr>
              `;
            });
            html += "</tbody></table>";
          }

          const info = document.getElementById("info-container");
          info.innerHTML = html;
          info.style.display = "block";
        }

        function mostrarTutores() {
            const tutores = [
              {% for t in tutores %}
                {
                  nombre: "{{ t.nombre|escapejs }}",
                  apellido: "{{ t.apellido|escapejs }}",
                  email: "{{ t.email|escapejs }}",
                  telefono1: "{{ t.telefono1|escapejs }}"
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ];

            let html = "<h3>Tutores</h3>";

            if (tutores.length === 0) {
              html += "<p>No hay tutores registrados para esta escuela.</p>";
            } else {
              html += `
                <table class='tabla-alumnos'>
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Apellido</th>
                      <th>Email</th>
                      <th>Tel√©fono</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              tutores.forEach(t => {
                html += `
                  <tr>
                    <td>${t.nombre}</td>
                    <td>${t.apellido}</td>
                    <td>${t.email}</td>
                    <td>${t.telefono1}</td>
                  </tr>
                `;
              });
              html += "</tbody></table>";
            }

            const info = document.getElementById("info-container");
            info.innerHTML = html;
            info.style.display = "block";
        }

        function mostrarDisciplinas() {
            const disciplinas = [
              {% for d in disciplinas %}
                {
                  nombre: "{{ d.disciplina|escapejs }}"
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ];

            let html = "<h3>Disciplinas</h3>";

            if (disciplinas.length === 0) {
              html += "<p>No hay disciplinas registradas para esta escuela.</p>";
            } else {
              html += "<ul>";
              disciplinas.forEach(d => {
                html += `<li>${d.nombre}</li>`;
              });
              html += "</ul>";
            }

            const info = document.getElementById("info-container");
            info.innerHTML = html;
            info.style.display = "block";
        }

        // ---- Resaltar card activa ----
        function marcarActiva(elemento) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('active-card'));
            elemento.classList.add('active-card');
        }

        // ---- Funciones Modal Capacitaci√≥n ----
        function abrirModalCapacitacion(e){ 
            if(e) e.preventDefault(); 
            document.getElementById('modal-capacitacion').style.display='block'; 
        }
        function cerrarModalCapacitacion(){ 
            document.getElementById('modal-capacitacion').style.display='none'; 
            document.getElementById('capacitacion-status').innerHTML=''; 
        }

        const formCapacitacion = document.getElementById('form-capacitacion');
        if (formCapacitacion) {
            formCapacitacion.addEventListener('submit', async function(ev){
              ev.preventDefault();
              const form = ev.target;
              const status = document.getElementById('capacitacion-status');
              const data = new FormData(form);
              status.innerHTML = 'Enviando...';
              try {
                const resp = await fetch("{% url 'accounts:enviar_capacitacion' %}", {
                  method: 'POST',
                  headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
                  body: data
                });
                const json = await resp.json();
                if (!resp.ok) throw new Error(json.error || 'Error al enviar');
                status.innerHTML = `Enviado a ${json.enviados} escuelas.`;
              } catch (err) {
                status.innerHTML = `<span style="color:red;">${err.message}</span>`;
              }
            });
        }
    </script>

    {% include 'accounts/includes/modal_capacitacion.html' %}

  </body>
</html>