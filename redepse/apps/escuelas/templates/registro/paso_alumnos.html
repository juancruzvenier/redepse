{% extends "registro/wizard_base.html" %}
{% load static %}

{% block paso_content %}
<form id="formAlumno" class="form-registro">
    {% csrf_token %}
    
    <h3 style="margin-bottom: 20px;">Registrar Alumno</h3>
    
    <div class="form-grid">
        <div class="form-field">
            <label for="dni_alumno">DNI *</label>
            <input type="number" id="dni_alumno" name="dni_alumno" class="form-control" required 
                   placeholder="Ej: 45987654" min="1000000" max="99999999">
        </div>

        <div class="form-field">
            <label for="nombre">Nombre *</label>
            <input type="text" id="nombre" name="nombre" class="form-control" required 
                   placeholder="Ej: Carlos">
        </div>

        <div class="form-field">
            <label for="apellido">Apellido *</label>
            <input type="text" id="apellido" name="apellido" class="form-control" required 
                   placeholder="Ej: López">
        </div>

        <div class="form-field">
            <label for="fecha_nac">Fecha de nacimiento *</label>
            <input type="date" id="fecha_nac" name="fecha_nac" class="form-control" required 
                   max="{{ hoy }}">
        </div>

        <div class="form-field">
            <label for="disciplina">Disciplina *</label>
            <select id="disciplina" name="disciplina" class="form-control" required>
                <option value="">Seleccione una disciplina</option>
                <!-- Las opciones se cargarán dinámicamente -->
            </select>
        </div>

        <div class="form-field">
            <label for="domicilio">Domicilio</label>
            <input type="text" id="domicilio" name="domicilio" class="form-control" 
                   placeholder="Ej: Calle Principal 123">
        </div>

        <div class="form-field">
            <label for="tutor">Tutor a cargo *</label>
            <select id="tutor" name="tutor" class="form-control" required>
                <option value="">Seleccione un tutor</option>
                <!-- Las opciones se cargarán dinámicamente -->
            </select>
        </div>
    </div>

    <div class="form-actions">
        <button type="button" class="btn-denegar" onclick="anteriorPaso()">
            ← Anterior
        </button>
        <button type="button" id="btnRegistrarAlumno" class="btn-aprobar" onclick="registrarAlumno()">
            Registrar Alumno
        </button>
    </div>
</form>

<!-- Tabla de alumnos registrados -->
<div id="tablaContainer" class="table-section" style="margin-top: 30px;">
    <h3>Alumnos Registrados</h3>
    <table id="tablaAlumnos" class="data-table">
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Fecha Nac.</th>
                <th>Disciplina</th>
                <th>Domicilio</th>
                <th>Tutor</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tbodyAlumnos">
            <!-- Los alumnos se cargarán aquí dinámicamente -->
        </tbody>
    </table>
    <p id="noDataAlumnos" class="no-data">Aún no hay alumnos registrados</p>
</div>

<div class="form-actions" style="margin-top: 20px;">
    <button type="button" id="btnSiguienteAlumnos" class="btn-siguiente" onclick="siguientePaso()" disabled>
        Siguiente →
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_nac').max = hoy;

    function anteriorPaso() {
        window.location.href = "{% url 'escuelas:registro_wizard' 'tutores' %}";
    }

    function cargarSelectores() {
        const datosGuardados = cargarDesdeLocalStorage();
        
        // Cargar disciplinas
        const selectDisciplina = document.getElementById('disciplina');
        selectDisciplina.innerHTML = '<option value="">Seleccione una disciplina</option>';
        
        if (datosGuardados.disciplinas && datosGuardados.disciplinas.ids) {
            // En una implementación real, aquí harías una petición para obtener los nombres
            // Por ahora usaremos los IDs directamente
            datosGuardados.disciplinas.ids.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `Disciplina ${id}`; // Temporal - deberías obtener el nombre real
                selectDisciplina.appendChild(option);
            });
        }

        // Cargar tutores
        const selectTutor = document.getElementById('tutor');
        selectTutor.innerHTML = '<option value="">Seleccione un tutor</option>';
        
        if (datosGuardados.tutores) {
            // Ordenar tutores por apellido
            const tutoresOrdenados = [...datosGuardados.tutores].sort((a, b) => 
                a.apellido.localeCompare(b.apellido)
            );
            
            tutoresOrdenados.forEach(tutor => {
                const option = document.createElement('option');
                option.value = tutor.dni_tutor;
                option.textContent = `${tutor.apellido}, ${tutor.nombre} (DNI: ${tutor.dni_tutor})`;
                selectTutor.appendChild(option);
            });
        }
    }

    function registrarAlumno() {
        const form = document.getElementById('formAlumno');
        const formData = new FormData(form);
        
        // Validar campos requeridos
        const camposRequeridos = ['dni_alumno', 'nombre', 'apellido', 'fecha_nac', 'disciplina', 'tutor'];
        for (let campo of camposRequeridos) {
            if (!formData.get(campo)) {
                showToast(`Complete el campo ${campo}`, 'error');
                return;
            }
        }

        // Crear objeto alumno
        const alumno = {};
        for (let [key, value] of formData.entries()) {
            alumno[key] = value;
        }

        // Obtener alumnos existentes
        const datosGuardados = cargarDesdeLocalStorage();
        const alumnos = datosGuardados.alumnos || [];

        // Verificar DNI duplicado
        if (alumnos.some(a => a.dni_alumno === alumno.dni_alumno)) {
            showToast('Ya existe un alumno con este DNI', 'error');
            return;
        }

        // Agregar nuevo alumno
        alumnos.push(alumno);
        guardarEnLocalStorage({ alumnos: alumnos });

        // Limpiar formulario
        form.reset();

        // Actualizar tabla
        actualizarTablaAlumnos();

        // Habilitar siguiente si hay al menos un alumno
        if (alumnos.length > 0) {
            document.getElementById('btnSiguienteAlumnos').disabled = false;
            document.getElementById('btnSiguienteAlumnos').classList.remove('btn-siguiente');
            document.getElementById('btnSiguienteAlumnos').classList.add('btn-aprobar');
        }

        showToast('Alumno registrado correctamente');
    }

    function eliminarAlumno(dni) {
        if (!confirm('¿Está seguro de eliminar este alumno?')) return;

        const datosGuardados = cargarDesdeLocalStorage();
        const alumnos = datosGuardados.alumnos || [];
        
        const nuevosAlumnos = alumnos.filter(a => a.dni_alumno !== dni);
        guardarEnLocalStorage({ alumnos: nuevosAlumnos });

        // Actualizar tabla
        actualizarTablaAlumnos();

        // Deshabilitar siguiente si no hay alumnos
        if (nuevosAlumnos.length === 0) {
            document.getElementById('btnSiguienteAlumnos').disabled = true;
            document.getElementById('btnSiguienteAlumnos').classList.remove('btn-aprobar');
            document.getElementById('btnSiguienteAlumnos').classList.add('btn-siguiente');
        }

        showToast('Alumno eliminado correctamente');
    }

    function actualizarTablaAlumnos() {
        const datosGuardados = cargarDesdeLocalStorage();
        const alumnos = datosGuardados.alumnos || [];
        const tbody = document.getElementById('tbodyAlumnos');
        const noData = document.getElementById('noDataAlumnos');

        tbody.innerHTML = '';

        if (alumnos.length === 0) {
            noData.style.display = 'block';
            return;
        }

        noData.style.display = 'none';
        
        alumnos.forEach(alumno => {
            // Obtener nombre del tutor
            let nombreTutor = 'No asignado';
            if (datosGuardados.tutores) {
                const tutor = datosGuardados.tutores.find(t => t.dni_tutor == alumno.tutor);
                if (tutor) {
                    nombreTutor = `${tutor.apellido}, ${tutor.nombre}`;
                }
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${alumno.dni_alumno}</td>
                <td>${alumno.nombre}</td>
                <td>${alumno.apellido}</td>
                <td>${alumno.fecha_nac}</td>
                <td>Disciplina ${alumno.disciplina}</td>
                <td>${alumno.domicilio || '-'}</td>
                <td>${nombreTutor}</td>
                <td>
                    <button type="button" class="btn-eliminar" 
                            onclick="eliminarAlumno('${alumno.dni_alumno}')">
                        Eliminar
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function siguientePaso() {
        const datosGuardados = cargarDesdeLocalStorage();
        const alumnos = datosGuardados.alumnos || [];
        
        if (alumnos.length > 0) {
            window.location.href = "{% url 'escuelas:registro_wizard' 'finalizar' %}";
        } else {
            showToast('Debe registrar al menos un alumno', 'error');
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        cargarSelectores();
        actualizarTablaAlumnos();
        
        const datosGuardados = cargarDesdeLocalStorage();
        const alumnos = datosGuardados.alumnos || [];
        
        if (alumnos.length > 0) {
            document.getElementById('btnSiguienteAlumnos').disabled = false;
            document.getElementById('btnSiguienteAlumnos').classList.remove('btn-siguiente');
            document.getElementById('btnSiguienteAlumnos').classList.add('btn-aprobar');
        }
    });
</script>
{% endblock %}