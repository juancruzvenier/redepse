{% extends "registro/wizard_base.html" %}
{% load static %}

{% block paso_content %}
<div class="resumen-registro">
    <div
        style="background: #eafaf1; padding: 20px; border-radius: 10px; border-left: 4px solid #00b894; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #0066ff;">‚ö†Ô∏è Informaci√≥n Importante</h3>
        <p style="margin-bottom: 10px; font-size: 1.1rem;">
            Al presionar "Enviar Solicitud", toda la informaci√≥n ser√° enviada a la Secretar√≠a de Deportes
            <strong>sin posibilidad de realizar cambios posteriores</strong>.
        </p>
        <p style="margin-bottom: 0; font-weight: 500;">
            La solicitud quedar√° a disposici√≥n de la Secretar√≠a para su aprobaci√≥n o rechazo.
        </p>
    </div>

    <h3 style="margin-bottom: 20px;">Resumen de la Solicitud</h3>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üìã Datos de la Escuela <a
                href="{% url 'escuelas:registro_wizard' 'escuela' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>

        <div id="resumenEscuela" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üìÑ Documentaci√≥n <a
                href="{% url 'escuelas:registro_wizard' 'documentacion' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>
        <div id="resumenDocumentacion" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üèÖ Disciplinas Seleccionadas<a
                href="{% url 'escuelas:registro_wizard' 'disciplinas' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>
        <div id="resumenDisciplinas" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üë®‚Äçüè´ Entrenadores Registrados<a
                href="{% url 'escuelas:registro_wizard' 'entrenadores' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>
        <div id="resumenEntrenadores" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Tutores Registrados<a
                href="{% url 'escuelas:registro_wizard' 'tutores' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>
        <div id="resumenTutores" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="resumen-section">
        <h4 style="display: flex; justify-content: space-between;">üéì Alumnos Registrados<a
                href="{% url 'escuelas:registro_wizard' 'alumnos' %}"><img src="../../../../static/img/pencil.svg"
                    width="20" height="20" alt="editar"></a> </h4>
        <div id="resumenAlumnos" class="resumen-datos">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <div class="form-actions" style="margin-top: 30px;">
        <button type="button" class="btn-denegar" onclick="anteriorPaso()">
            ‚Üê Anterior
        </button>
        <button type="button" id="btnEnviarSolicitud" class="btn-aprobar" onclick="enviarSolicitud()">
            Enviar Solicitud
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // 1. DEFINICI√ìN DE CONSTANTES (Esto faltaba o estaba mal escrito)
    // Deben coincidir EXACTAMENTE con las del paso_documentacion
    const DB_NAME = "RedepseFilesDB";
    const STORE_NAME = "archivos";

    function anteriorPaso() {
        // Redirigir al paso anterior l√≥gico (usualmente alumnos)
        window.location.href = "{% url 'escuelas:registro_wizard' 'alumnos' %}";
    }

    async function enviarSolicitud() {
        if (!confirm('¬øEst√° seguro de enviar la solicitud? Esta acci√≥n no se puede deshacer.')) {
            return;
        }

        const btnEnviar = document.getElementById('btnEnviarSolicitud');
        btnEnviar.disabled = true;
        btnEnviar.textContent = 'Procesando archivos...';

        try {
            // A. Obtener datos JSON del localStorage
            const datosCompletos = cargarDesdeLocalStorage();
            console.log("Datos localStorage:", datosCompletos); // Debug

            // Validaciones b√°sicas
            const pasosRequeridos = ['escuela', 'disciplinas', 'entrenadores', 'tutores', 'alumnos'];
            const pasosFaltantes = pasosRequeridos.filter(paso => !datosCompletos[paso]);

            if (pasosFaltantes.length > 0) {
                throw new Error(`Faltan datos en: ${pasosFaltantes.join(', ')}`);
            }

            // B. Preparar FormData
            const formData = new FormData();
            formData.append('datos_json', JSON.stringify(datosCompletos));

            // C. RECUPERAR ARCHIVOS DE INDEXEDDB
            // Intentamos recuperar los archivos. Si no hay documentaci√≥n en el localStorage,
            // asumimos que no hay archivos, pero intentamos buscarlos igual si el paso existe.
            if (datosCompletos.documentacion && datosCompletos.documentacion.completado) {
                try {
                    const notaFile = await obtenerArchivoDeDB('nota_secretario');
                    const respaldoFile = await obtenerArchivoDeDB('respaldo_institucional');

                    if (notaFile) {
                        // Usamos el nombre guardado en los metadatos o uno gen√©rico
                        const nombreNota = datosCompletos.documentacion.nota_secretario?.nombre || 'nota_secretario.pdf';
                        formData.append('nota_secretario', notaFile, nombreNota);
                    }
                    if (respaldoFile) {
                        const nombreRespaldo = datosCompletos.documentacion.respaldo_institucional?.nombre || 'respaldo_institucional.pdf';
                        formData.append('respaldo_institucional', respaldoFile, nombreRespaldo);
                    }
                } catch (dbError) {
                    console.error("Error leyendo DB:", dbError);
                    // No detenemos el env√≠o, pero avisamos en consola
                }
            }

            btnEnviar.textContent = 'Enviando al servidor...';

            // D. Enviar al servidor
            const response = await fetch("{% url 'escuelas:finalizar_registro' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Error en el servidor');
            }

            if (data.success) {
                showToast(data.message, 'success');
                
                // Limpieza total
                limpiarLocalStorage();
                borrarBaseDeDatos(); 
                
                setTimeout(() => {
                    window.location.href = "{% url 'escuelas:estado' %}";
                }, 2000);
            } else {
                throw new Error(data.error || 'Error desconocido');
            }

        } catch (error) {
            console.error('Error:', error);
            showToast('Error: ' + error.message, 'error');
            btnEnviar.disabled = false;
            btnEnviar.textContent = 'Enviar Solicitud';
        }
    }

    // --- Funciones Helper para IndexedDB ---

    function obtenerArchivoDeDB(key) {
        return new Promise((resolve, reject) => {
            // Abrimos la base de datos definida en las constantes al inicio
            const request = indexedDB.open(DB_NAME, 1);
            
            request.onerror = (e) => {
                console.warn("No se pudo abrir DB para leer archivo:", key);
                resolve(null);
            };
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    console.warn("Store no encontrado:", STORE_NAME);
                    resolve(null);
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const getRequest = store.get(key);

                getRequest.onsuccess = () => {
                    if (getRequest.result) {
                        resolve(getRequest.result); // Devuelve el Blob/File
                    } else {
                        console.warn("Archivo no encontrado en DB:", key);
                        resolve(null);
                    }
                };
                
                getRequest.onerror = () => resolve(null);
            };
        });
    }

    function borrarBaseDeDatos() {
        const req = indexedDB.deleteDatabase(DB_NAME);
        req.onsuccess = () => {
            console.log("Base de datos temporal eliminada correctamente");
        };
        req.onerror = () => {
            console.log("Error al intentar borrar la base de datos temporal");
        };
    }
    
    function cargarResumen() {
        const datosGuardados = cargarDesdeLocalStorage();

        // Resumen Escuela
        const resumenEscuela = document.getElementById('resumenEscuela');
        if (datosGuardados.escuela) {
            const escuela = datosGuardados.escuela;
            
            // Verificamos si hay coordenadas para mostrar un mensajito o link
            let ubicacionHTML = '<p><strong>Ubicaci√≥n:</strong> No especificada</p>';
            if (escuela.latitud && escuela.longitud) {
                // Link a Google Maps para verificar visualmente
                ubicacionHTML = `
                    <p><strong>Ubicaci√≥n:</strong> 
                    <a href="https://www.google.com/maps?q=${escuela.latitud},${escuela.longitud}" target="_blank" style="color: #0066ff;">
                        üìç Ver en mapa
                    </a>
                    </p>`;
            }

            resumenEscuela.innerHTML = `
                <p><strong>Nombre:</strong> ${escuela.nombre_esc}</p>
                <p><strong>Localidad:</strong> ${escuela.localidad}</p>
                <p><strong>Direcci√≥n:</strong> ${escuela.direccion}</p>
                <p><strong>Email:</strong> ${escuela.email}</p>
                <p><strong>Tel√©fono:</strong> ${escuela.telefono1}</p>
                ${ubicacionHTML} `;
        } else {
            resumenEscuela.innerHTML = '<p style="color: #e84118;">No se encontraron datos de la escuela</p>';
        }

        // Resumen Documentaci√≥n
        const resumenDocumentacion = document.getElementById('resumenDocumentacion');
        if (datosGuardados.documentacion && datosGuardados.documentacion.completado) {
            const doc = datosGuardados.documentacion;
            let html = '';
            // Verificamos si existen los objetos con los nombres
            if (doc.nota_secretario && doc.nota_secretario.nombre) {
                html += `<p><strong>Nota al secretario:</strong> ${doc.nota_secretario.nombre}</p>`;
            }
            if (doc.respaldo_institucional && doc.respaldo_institucional.nombre) {
                html += `<p><strong>Respaldo institucional:</strong> ${doc.respaldo_institucional.nombre}</p>`;
            }
            resumenDocumentacion.innerHTML = html || '<p style="color: #e84118;">Documentaci√≥n incompleta</p>';
        } else {
            resumenDocumentacion.innerHTML = '<p style="color: #e84118;">No se carg√≥ documentaci√≥n</p>';
        }

        // Resumen Disciplinas
        const resumenDisciplinas = document.getElementById('resumenDisciplinas');
        if (datosGuardados.disciplinas && datosGuardados.disciplinas.nombres) {
            const lista = datosGuardados.disciplinas.nombres.map(nombre =>
                `<span class="badge">${nombre}</span>`
            ).join('');
            resumenDisciplinas.innerHTML = lista;
        } else {
            resumenDisciplinas.innerHTML = '<p style="color: #e84118;">No se seleccionaron disciplinas</p>';
        }

        // Resumen Entrenadores
        const resumenEntrenadores = document.getElementById('resumenEntrenadores');
        if (datosGuardados.entrenadores && datosGuardados.entrenadores.length > 0) {
            resumenEntrenadores.innerHTML = `<p><strong>Total:</strong> ${datosGuardados.entrenadores.length} entrenador(es) registrado(s)</p>`;
        } else {
            resumenEntrenadores.innerHTML = '<p style="color: #e84118;">No se registraron entrenadores</p>';
        }

        // Resumen Tutores
        const resumenTutores = document.getElementById('resumenTutores');
        if (datosGuardados.tutores && datosGuardados.tutores.length > 0) {
            resumenTutores.innerHTML = `<p><strong>Total:</strong> ${datosGuardados.tutores.length} tutor(es) registrado(s)</p>`;
        } else {
            resumenTutores.innerHTML = '<p style="color: #e84118;">No se registraron tutores</p>';
        }

        // Resumen Alumnos
        const resumenAlumnos = document.getElementById('resumenAlumnos');
        if (datosGuardados.alumnos && datosGuardados.alumnos.length > 0) {
            resumenAlumnos.innerHTML = `<p><strong>Total:</strong> ${datosGuardados.alumnos.length} alumno(s) registrado(s)</p>`;
        } else {
            resumenAlumnos.innerHTML = '<p style="color: #e84118;">No se registraron alumnos</p>';
        }
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function () {
        cargarResumen();
    });
</script>

<style>
    .resumen-section {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .resumen-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #0066ff;
        border-bottom: 2px solid #0066ff;
        padding-bottom: 5px;
    }

    .resumen-datos p {
        margin: 5px 0;
    }

    .badge {
        display: inline-block;
        background: #0066ff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        margin: 2px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}