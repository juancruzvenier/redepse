{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registro - Entrenadores</title>
    <link rel="stylesheet" href="{% static 'escuelas/css/wizard.css' %}" />
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="logo">
          <img src="{% static 'accounts/img/logo.jpeg' %}" alt="Logo" />
          <h2>REDEPSE</h2>
        </div>

        <nav>
          <ul>
            <li>
              <a
                href="{% url 'escuelas:wizard' %}"
                class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}"
              >
                Datos de la Escuela
              </a>
            </li>
            <li>
              <a
                href="{% url 'escuelas:wizard' %}"
                class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}"
              >
                Profesores
              </a>
            </li>
            <li><a href="{% url 'escuelas:wizard' %}" class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}"">Alumnos</a></li>
            <li><a href="{% url 'escuelas:wizard' %}" class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">Carga de nota al secretario</a></li>
          </ul>
        </nav>

        <div class="logout">
          <a href="{% url 'accounts:logout' %}">Cerrar sesi√≥n</a>
        </div>
      </aside>

      <main class="content">
        <header>
          <h1>Registro de Escuela</h1>
          <h2 class="subtitle">Entrenadores</h2>
        </header>

        <section class="table-section">
          <h2 style="margin-bottom: 15px">Datos de Entrenador</h2>

          <form method="post" class="form-registro">
            {% csrf_token %}

            <!-- Campos -->
            <div class="form-grid">
              {{ form.nombre.errors }}
              <div class="form-field">
                <label for="{{ form.nombre.id_for_label }}"
                  >Nombre</label
                >
                {{ form.nombre }}
              </div>

              <div class="form-field">
                <label for="{{ form.apellido.id_for_label }}"
                  >Apellido</label
                >
                {{ form.apellido }}
              </div>

              <div class="form-field">
                <label for="{{ form.fecha_nac.id_for_label }}">{{ form.fecha_nac }}</label>
              </div>

              <div class="form-field">
                <label for="{{ form.email.id_for_label }}"
                  >Email</label
                >
                {{ form.email }}
              </div>

              <div class="form-field">
                <label for="{{ form.telefono.id_for_label }}"
                  >Tel√©fono</label
                >
                {{ form.telefono }}
              </div>

              <div class="form-field">
                <label for="{{ form.domicilio.id_for_label }}"
                  >Domicilio</label
                >
                {{ form.domicilio }}
              </div>

            <div class="form-actions">
              <button type="submit" class="btn-aprobar">Siguiente</button>
            </div>
            <button type="submit" class="btn-primary">
            Registrar Entrenador
            </button>
          </form>
        </section>
        <section id="tablaContainer" class="table-section">
          <h3>Entrenadores registrados</h3>
          <table id="tablaEntrenadores" class="data-table">
            <thead>
              <tr>
                <th>DNI</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Fecha nac.</th>
                <th>Email</th>
                <th>Tel√©fono</th>
                <th>Domicilio</th>
                <th>Periodo</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p id="noData" class="no-data">A√∫n no hay entrenadores registrados</p>
        </section>

        <section class="next-section">
          <button id="btnSiguiente" class="btn-success" disabled>
            Siguiente ‚Üí
          </button>
        </section>

        <div id="toast" class="toast">
          ‚úÖ Entrenador registrado correctamente
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("entrenadorForm");
        const tabla = document.querySelector("#tablaEntrenadores tbody");
        const noData = document.getElementById("noData");
        const toast = document.getElementById("toast");
        const btnSiguiente = document.getElementById("btnSiguiente");

        const getCSRF = () =>
          document.querySelector("[name=csrfmiddlewaretoken]").value;

        const fetchEntrenadores = async () => {
          const res = await fetch("/api/entrenadores/");
          const data = await res.json();
          tabla.innerHTML = "";
          if (data.length > 0) {
            noData.style.display = "none";
            data.forEach((e) => {
              const row = document.createElement("tr");
              row.innerHTML = `
            <td>${e.dni_ent}</td>
            <td>${e.nombre}</td>
            <td>${e.apellido}</td>
            <td>${e.fecha_nac}</td>
            <td>${e.email || "-"}</td>
            <td>${e.telefono || "-"}</td>
            <td>${e.domicilio}</td>
            <td>${e.periodo__anio}</td>
            <td><button data-id="${e.id}" class="btn-delete">üóëÔ∏è</button></td>
            `;
              tabla.appendChild(row);
            });
            btnSiguiente.disabled = false;
          } else {
            noData.style.display = "block";
            btnSiguiente.disabled = true;
          }
        };

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = Object.fromEntries(new FormData(form));
          const res = await fetch("/api/entrenadores/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRF(),
            },
            body: JSON.stringify(formData),
          });
          if (res.ok) {
            form.reset();
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 2500);
            await fetchEntrenadores();
          } else {
            const data = await res.json();
            alert("Error: " + JSON.stringify(data.errors));
          }
        });

        tabla.addEventListener("click", async (e) => {
          if (e.target.classList.contains("btn-delete")) {
            const id = e.target.dataset.id;
            await fetch(`/api/entrenadores/delete/${id}/`, {
              method: "DELETE",
              headers: { "X-CSRFToken": getCSRF() },
            });
            await fetchEntrenadores();
          }
        });

        fetchEntrenadores();
      });
    </script>
  </body>
</html>
