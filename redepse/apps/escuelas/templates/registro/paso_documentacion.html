{% extends "registro/wizard_base.html" %} {% load static %}
{% block paso_content %}
<form id="formDocumentacion" class="form-registro">
  {% csrf_token %}

  <div class="form-grid">
    <div class="form-field">
      <label for="nota_secretario">Nota dirigida al Secretario de Deportes y Recreaci√≥n*</label>
      <input
        type="file"
        id="nota_secretario"
        name="nota_secretario"
        class="form-control"
        required
        accept=".doc,.docx,.pdf"
      />
      <small style="color: #666">Formatos aceptados: .doc, .docx, .pdf</small>

      <!-- Vista previa del documento -->
      <div
        id="previewNota"
        class="document-preview"
        style="display: none; margin-top: 10px"
      >
        <a
          id="linkNota"
          target="_blank"
          style="color: #0066ff; text-decoration: none"
        >
          üìÑ <span id="nombreNota"></span>
        </a>
        <button
          type="button"
          onclick="eliminarDocumento('nota_secretario')"
          style="
            margin-left: 10px;
            color: #e84118;
            border: none;
            background: none;
            cursor: pointer;
          "
        >
          üóëÔ∏è
        </button>
      </div>
    </div>

    <div class="form-field">
      <label for="respaldo_institucional">Respaldo/Aval institucional *</label>
      <input
        type="file"
        id="respaldo_institucional"
        name="respaldo_institucional"
        class="form-control"
        required
        accept=".doc,.docx,.pdf"
      />
      <small style="color: #666">Formatos aceptados: .doc, .docx, .pdf</small>

      <!-- Vista previa del documento -->
      <div
        id="previewRespaldo"
        class="document-preview"
        style="display: none; margin-top: 10px"
      >
        <a
          id="linkRespaldo"
          target="_blank"
          style="color: #0066ff; text-decoration: none"
        >
          üìÑ <span id="nombreRespaldo"></span>
        </a>
        <button
          type="button"
          onclick="eliminarDocumento('respaldo_institucional')"
          style="
            margin-left: 10px;
            color: #e84118;
            border: none;
            background: none;
            cursor: pointer;
          "
        >
          üóëÔ∏è
        </button>
      </div>
    </div>
  </div>

  <div
    style="
      background: #eafaf1;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      border-left: 4px solid #00b894;
    "
  >
    <h4 style="margin-top: 0; color: #0066ff">üìã Documentaci√≥n Requerida</h4>
    <ul style="margin-bottom: 0">
      <li>
        <strong>Nota al Secretario de Deportes y Recreaci√≥n:</strong> Solicitud formal de
        habilitaci√≥n
      </li>
      <li>
        <strong>Respaldo institucional:</strong> Documentaci√≥n que acredite la existencia de la
        instituci√≥n
      </li>
    </ul>
  </div>

  <div class="form-actions">
    <button type="button" class="btn-denegar" onclick="anteriorPaso()">
      ‚Üê Anterior
    </button>
    <button
      type="button"
      id="btnGuardarDocumentacion"
      class="btn-guardar"
      onclick="guardarDocumentacion()"
    >
      Guardar
    </button>
    <button
      type="button"
      id="btnSiguienteDocumentacion"
      class="btn-siguiente"
      onclick="siguientePaso()"
      disabled
    >
      Siguiente ‚Üí
    </button>
  </div>
</form>
{% endblock %} {% block extra_scripts %}
<script>
  let db;
  const DB_NAME = "RedepseFilesDB";
  const STORE_NAME = "archivos";

  document.addEventListener("DOMContentLoaded", function () {
    // 1. Iniciar IndexedDB
    const request = indexedDB.open(DB_NAME, 1);

    request.onerror = (event) => console.error("Error DB:", event);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME);
      }
    };

    request.onsuccess = (event) => {
      db = event.target.result;
      // Cargar vista previa si ya existen archivos
      cargarVistasPreviasExistentes();
    };

    // Configurar listeners
    const notaInput = document.getElementById("nota_secretario");
    const respaldoInput = document.getElementById("respaldo_institucional");

    notaInput.addEventListener("change", (e) => manejarSeleccionArchivo(e, "nota_secretario"));
    respaldoInput.addEventListener("change", (e) => manejarSeleccionArchivo(e, "respaldo_institucional"));
  });

  function manejarSeleccionArchivo(event, tipo) {
    const file = event.target.files[0];
    if (!file) return;

    const ext = file.name.split(".").pop().toLowerCase();
    if (!["doc", "docx", "pdf"].includes(ext)) {
      showToast("Solo se permiten archivos .doc, .docx o .pdf", "error");
      event.target.value = "";
      return;
    }

    // 1. Guardar en IndexedDB (Archivo real)
    guardarEnDB(tipo, file);

    // 2. Guardar Metadatos individuales en LocalStorage (Para persistencia r√°pida)
    const metaDataKey = `meta_${tipo}`;
    const metaInfo = {
        nombre: file.name,
        tipo: file.type,
        size: file.size
    };
    localStorage.setItem(metaDataKey, JSON.stringify(metaInfo));

    // 3. Mostrar vista previa (usamos el archivo directo que acaba de subir el usuario)
    const url = URL.createObjectURL(file);
    actualizarDOMPreview(tipo, file.name, url);
    
    verificarEstadoBoton();
  }

  function guardarEnDB(key, file) {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    store.put(file, key);
  }

  // Funci√≥n auxiliar para actualizar el HTML de la vista previa
  function actualizarDOMPreview(tipo, nombre, url) {
    const sufijo = tipo === "nota_secretario" ? "Nota" : "Respaldo";
    const previewDiv = document.getElementById(`preview${sufijo}`);
    const link = document.getElementById(`link${sufijo}`);
    const nombreSpan = document.getElementById(`nombre${sufijo}`);

    if (previewDiv && link && nombreSpan) {
        previewDiv.style.display = "block";
        nombreSpan.textContent = nombre;
        link.href = url; // Asignamos la URL real (blob)
        
        // Limpieza de memoria: si ya hab√≠a una URL blob anterior, liberarla podr√≠a ser buena pr√°ctica,
        // pero para este alcance, dejar que el navegador lo maneje al recargar est√° bien.
    }
  }

  // Esta funci√≥n recupera los archivos de la DB al recargar la p√°gina para generar los links
  function cargarVistasPreviasExistentes() {
    ['nota_secretario', 'respaldo_institucional'].forEach(tipo => {
        // Primero verificamos si hay metadatos (nombre)
        const meta = localStorage.getItem(`meta_${tipo}`);
        if (meta) {
            const data = JSON.parse(meta);
            
            // Ahora recuperamos el archivo real de la DB para generar el link
            const transaction = db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(tipo);

            request.onsuccess = () => {
                const fileBlob = request.result;
                if (fileBlob) {
                    const url = URL.createObjectURL(fileBlob);
                    actualizarDOMPreview(tipo, data.nombre, url);
                }
            };
        }
    });
    verificarEstadoBoton();
  }

  function eliminarDocumento(tipo) {
    // 1. Borrar de IndexedDB
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    store.delete(tipo);

    // 2. Borrar de LocalStorage
    localStorage.removeItem(`meta_${tipo}`);

    // 3. Limpiar UI
    document.getElementById(tipo).value = "";
    const sufijo = tipo === "nota_secretario" ? "Nota" : "Respaldo";
    document.getElementById(`preview${sufijo}`).style.display = "none";
    
    verificarEstadoBoton();
  }

  function verificarEstadoBoton() {
    const notaOk = localStorage.getItem("meta_nota_secretario");
    const respaldoOk = localStorage.getItem("meta_respaldo_institucional");
    
    const btnGuardar = document.getElementById("btnGuardarDocumentacion");
    const btnSiguiente = document.getElementById("btnSiguienteDocumentacion");

    // Habilitar "Guardar" si hay archivos
    // En este flujo, como ya se guarda en DB al seleccionar, el bot√≥n "Guardar" 
    // act√∫a m√°s como una confirmaci√≥n para pasar al objeto principal.
    if (notaOk && respaldoOk) {
        btnGuardar.disabled = false;
        
        // Verificamos si ya se hizo clic en guardar antes (si existe en el objeto principal)
        const datosGlobales = cargarDesdeLocalStorage();
        if (datosGlobales.documentacion && datosGlobales.documentacion.completado) {
             btnSiguiente.disabled = false;
             btnSiguiente.classList.remove("btn-siguiente");
             btnSiguiente.classList.add("btn-aprobar");
        }
    } else {
        btnGuardar.disabled = true; // Si falta alguno, no se puede guardar
        btnSiguiente.disabled = true;
    }
  }

  function guardarDocumentacion() {
    const metaNota = localStorage.getItem("meta_nota_secretario");
    const metaRespaldo = localStorage.getItem("meta_respaldo_institucional");

    if (!metaNota || !metaRespaldo) {
      showToast("Debe subir ambos documentos", "error");
      return;
    }

    // AQU√ç ESTABA EL ERROR: Reconstruimos el objeto completo para que el Resumen lo lea
    const docData = {
        nota_secretario: JSON.parse(metaNota),
        respaldo_institucional: JSON.parse(metaRespaldo),
        completado: true
    };

    // Guardamos en el objeto principal del wizard
    guardarEnLocalStorage({ documentacion: docData });
    
    showToast("Documentaci√≥n confirmada correctamente");
    
    // Habilitar visualmente el siguiente paso
    const btnSiguiente = document.getElementById("btnSiguienteDocumentacion");
    btnSiguiente.disabled = false;
    btnSiguiente.classList.remove("btn-siguiente");
    btnSiguiente.classList.add("btn-aprobar");
    
    document.getElementById("btnGuardarDocumentacion").disabled = true;
  }

  function siguientePaso() {
    const datos = cargarDesdeLocalStorage();
    if (datos.documentacion && datos.documentacion.completado) {
      window.location.href = "{% url 'escuelas:registro_wizard' 'disciplinas' %}";
    } else {
      showToast("Debe guardar la documentaci√≥n antes de continuar", "error");
    }
  }

  function anteriorPaso() {
    window.location.href = "{% url 'escuelas:registro_wizard' 'escuela' %}";
  }
</script>

<style>
  .document-preview {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border: 1px solid #dee2e6;
  }

  .document-preview a:hover {
    text-decoration: underline;
  }
</style>
{% endblock %}