{% extends "registro/wizard_base.html" %}
{% load static %}

{% block paso_content %}
<form id="formEscuela" class="form-registro">
    {% csrf_token %}
    
    <div class="form-grid">
        <div class="form-field">
            <label for="nombre_esc">Nombre de la escuela *</label>
            <input type="text" id="nombre_esc" name="nombre_esc" class="form-control" required 
                   placeholder="Ej: Escuela Deportiva Central">
        </div>

        <div class="form-field">
            <label for="localidad">Localidad *</label>
            <select id="localidad" name="localidad" class="form-control" required>
                <option value="">Seleccione una localidad</option>
                <option value="Santiago del Estero">Santiago del Estero (Capital)</option>
                <option value="La Banda">La Banda</option>
                <option value="Frías">Frías</option>
                <option value="Añatuya">Añatuya</option>
                <option value="Quimilí">Quimilí</option>
                <option value="Loreto">Loreto</option>
                <option value="Clodomira">Clodomira</option>
                <option value="Termas de Río Hondo">Termas de Río Hondo</option>
                <option value="Monte Quemado">Monte Quemado</option>
                <option value="Sumampa">Sumampa</option>
                <option value="Fernández">Fernández</option>
                <option value="Selva">Selva</option>
                <option value="Icaño">Icaño</option>
                <option value="Pinto">Pinto</option>
                <option value="Villa Atamisqui">Villa Atamisqui</option>
                <option value="Bandera">Bandera</option>
                <option value="Los Telares">Los Telares</option>
                <option value="Villa Ojo de Agua">Villa Ojo de Agua</option>
                <option value="Suncho Corral">Suncho Corral</option>
            </select>
        </div>

        <div class="form-field">
            <label for="direccion">Dirección de la escuela *</label>
            <input type="text" id="direccion" name="direccion" class="form-control" required 
                   placeholder="Ej: Av. Central 123">
        </div>

        <div class="form-field">
            <label for="email">Correo electrónico *</label>
            <input type="email" id="email" name="email" class="form-control" required 
                   placeholder="ejemplo@escuela.com">
        </div>

        <div class="form-field">
            <label for="telefono1">Teléfono de contacto *</label>
            <input type="tel" id="telefono1" name="telefono1" class="form-control" required 
                   placeholder="Ej: 3854123456" pattern="[0-9]+" 
                   title="Solo se permiten números">
        </div>
    </div>

    <div class="form-actions">
        <button type="button" id="btnGuardarEscuela" class="btn-guardar" onclick="guardarEscuela()">
            Guardar
        </button>
        <button type="button" id="btnSiguienteEscuela" class="btn-siguiente" onclick="siguientePaso()" disabled>
            Siguiente →
        </button>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
    let escuelaGuardada = false;

    function guardarEscuela() {
        const form = document.getElementById('formEscuela');
        const formData = new FormData(form);
        
        // Validar campos
        if (!validarCamposRequeridos('formEscuela')) {
            showToast('Complete todos los campos requeridos', 'error');
            return;
        }

        // Guardar en localStorage
        const datosEscuela = {};
        for (let [key, value] of formData.entries()) {
            datosEscuela[key] = value;
        }
        
        guardarEnLocalStorage({ escuela: datosEscuela });
        escuelaGuardada = true;
        
        // Actualizar estado de botones
        document.getElementById('btnGuardarEscuela').disabled = true;
        document.getElementById('btnSiguienteEscuela').disabled = false;
        document.getElementById('btnSiguienteEscuela').classList.remove('btn-siguiente');
        document.getElementById('btnSiguienteEscuela').classList.add('btn-aprobar');
        
        showToast('Datos de escuela guardados correctamente');
    }

    function siguientePaso() {
        if (escuelaGuardada) {
            window.location.href = "{% url 'escuelas:registro_wizard' 'documentacion' %}";
        } else {
            showToast('Debe guardar los datos antes de continuar', 'error');
        }
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        const datosGuardados = cargarDesdeLocalStorage();
        if (datosGuardados.escuela) {
            // Prellenar formulario
            const escuelaData = datosGuardados.escuela;
            for (const [key, value] of Object.entries(escuelaData)) {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) field.value = value;
            }
            escuelaGuardada = true;
            document.getElementById('btnSiguienteEscuela').disabled = false;
            document.getElementById('btnSiguienteEscuela').classList.remove('btn-siguiente');
            document.getElementById('btnSiguienteEscuela').classList.add('btn-aprobar');
        }

        configurarDeteccionCambios('formEscuela', 'btnGuardarEscuela');
    });
</script>
{% endblock %}