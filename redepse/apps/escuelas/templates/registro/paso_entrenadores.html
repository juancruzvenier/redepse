{% extends "registro/wizard_base.html" %}
{% load static %}

{% block paso_content %}
<form id="formEntrenador" class="form-registro">
    {% csrf_token %}
    
    <h3 style="margin-bottom: 20px;">Registrar Entrenador</h3>
    
    <div class="form-grid">
        <div class="form-field">
            <label for="dni_ent">DNI *</label>
            <input type="number" id="dni_ent" name="dni_ent" class="form-control" required 
                   placeholder="Ej: 40123456" min="1000000" max="99999999">
        </div>

        <div class="form-field">
            <label for="nombre">Nombre *</label>
            <input type="text" id="nombre" name="nombre" class="form-control" required 
                   placeholder="Ej: Juan">
        </div>

        <div class="form-field">
            <label for="apellido">Apellido *</label>
            <input type="text" id="apellido" name="apellido" class="form-control" required 
                   placeholder="Ej: P√©rez">
        </div>

        <div class="form-field">
            <label for="fecha_nac">Fecha de nacimiento *</label>
            <input type="date" id="fecha_nac" name="fecha_nac" class="form-control" required 
                   max="{{ hoy }}">
        </div>

        <div class="form-field">
            <label for="email">Correo electr√≥nico</label>
            <input type="email" id="email" name="email" class="form-control" 
                   placeholder="ejemplo@email.com">
        </div>

        <div class="form-field">
            <label for="telefono">Tel√©fono</label>
            <input type="tel" id="telefono" name="telefono" class="form-control" 
                   placeholder="Ej: 3854123456" pattern="[0-9]+">
        </div>

        <div class="form-field">
            <label for="domicilio">Domicilio</label>
            <input type="text" id="domicilio" name="domicilio" class="form-control" 
                   placeholder="Ej: Calle Principal 123">
        </div>

        <div class="form-field" style="grid-column: 1 / -1;">
            <label for="buena_conducta">Certificado de Buena Conducta (PDF) *</label>
            <input type="file" id="buena_conducta" name="buena_conducta" class="form-control" 
                   accept=".pdf,.doc,.docx" required>
            <small style="color: #666;">Formatos aceptados: .pdf, .doc, .docx</small>
        </div>
    </div>

    <div class="form-actions">
        <button type="button" class="btn-denegar" onclick="anteriorPaso()">
            ‚Üê Anterior
        </button>
        <button type="button" id="btnRegistrarEntrenador" class="btn-aprobar" onclick="registrarEntrenador()">
            Registrar Entrenador
        </button>
    </div>
</form>

<div id="tablaContainer" class="table-section" style="margin-top: 30px;">
    <h3>Entrenadores Registrados</h3>
    <table id="tablaEntrenadores" class="data-table">
        <thead>
            <tr>
                <th>DNI</th>
                <th>Nombre y Apellido</th>
                <th>Contacto</th>
                <th>Documentaci√≥n</th> <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tbodyEntrenadores">
            </tbody>
    </table>
    <p id="noDataEntrenadores" class="no-data">A√∫n no hay entrenadores registrados</p>
</div>

<div class="form-actions" style="margin-top: 20px;">
    <button type="button" id="btnSiguienteEntrenadores" class="btn-siguiente" onclick="siguientePaso()" disabled>
        Siguiente ‚Üí
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Configuraci√≥n DB
    let db;
    const DB_NAME = "RedepseFilesDB";
    const STORE_NAME = "archivos";
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_nac').max = hoy;

    // --- INICIALIZAR DB ---
    document.addEventListener('DOMContentLoaded', function() {
        const request = indexedDB.open(DB_NAME, 1);
        
        request.onerror = (event) => console.error("Error DB:", event);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            actualizarTablaEntrenadores(); // Cargar tabla reci√©n cuando la DB est√© lista
            verificarBotonSiguiente();
        };
    });

    function anteriorPaso() {
        window.location.href = "{% url 'escuelas:registro_wizard' 'disciplinas' %}";
    }

    function registrarEntrenador() {
        const form = document.getElementById('formEntrenador');
        const formData = new FormData(form);
        const fileInput = document.getElementById('buena_conducta');
        
        // 1. Validaciones
        const camposRequeridos = ['dni_ent', 'nombre', 'apellido', 'fecha_nac'];
        for (let campo of camposRequeridos) {
            if (!formData.get(campo)) {
                showToast(`Complete el campo ${campo}`, 'error');
                return;
            }
        }

        if (fileInput.files.length === 0) {
            showToast('Debe subir el certificado de buena conducta', 'error');
            return;
        }

        const archivo = fileInput.files[0];
        // Validar extensi√≥n
        const ext = archivo.name.split('.').pop().toLowerCase();
        if (!['pdf', 'doc', 'docx'].includes(ext)) {
            showToast('Solo se permiten archivos PDF o Word', 'error');
            return;
        }

        // Crear objeto entrenador
        const entrenador = {};
        for (let [key, value] of formData.entries()) {
            if (key !== 'buena_conducta') { // No guardamos el archivo en el objeto JSON
                entrenador[key] = value;
            }
        }

        // Obtener entrenadores existentes
        const datosGuardados = cargarDesdeLocalStorage();
        const entrenadores = datosGuardados.entrenadores || [];

        // Verificar DNI duplicado
        if (entrenadores.some(e => e.dni_ent === entrenador.dni_ent)) {
            showToast('Ya existe un entrenador con este DNI', 'error');
            return;
        }

        // Agregar metadatos del archivo al objeto entrenador
        entrenador.archivo_nombre = archivo.name;
        
        // 2. GUARDAR EN INDEXEDDB (Clave √∫nica: entrenador_conducta_DNI)
        const dbKey = `entrenador_conducta_${entrenador.dni_ent}`;
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        store.put(archivo, dbKey);

        transaction.oncomplete = () => {
            // 3. GUARDAR EN LOCALSTORAGE Y ACTUALIZAR
            entrenadores.push(entrenador);
            guardarEnLocalStorage({ entrenadores: entrenadores });

            form.reset();
            actualizarTablaEntrenadores();
            verificarBotonSiguiente();
            showToast('Entrenador registrado correctamente');
        };

        transaction.onerror = () => {
            showToast('Error al guardar el archivo', 'error');
        };
    }

    function eliminarEntrenador(dni) {
        if (!confirm('¬øEst√° seguro de eliminar este entrenador?')) return;

        // 1. Eliminar de LocalStorage
        const datosGuardados = cargarDesdeLocalStorage();
        let entrenadores = datosGuardados.entrenadores || [];
        entrenadores = entrenadores.filter(e => e.dni_ent !== dni.toString());
        guardarEnLocalStorage({ entrenadores: entrenadores });

        // 2. Eliminar de IndexedDB
        if (db) {
            const dbKey = `entrenador_conducta_${dni}`;
            const transaction = db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            store.delete(dbKey);
        }

        actualizarTablaEntrenadores();
        verificarBotonSiguiente();
        showToast('Entrenador eliminado correctamente');
    }

    function actualizarTablaEntrenadores() {
        const datosGuardados = cargarDesdeLocalStorage();
        const entrenadores = datosGuardados.entrenadores || [];
        const tbody = document.getElementById('tbodyEntrenadores');
        const noData = document.getElementById('noDataEntrenadores');

        tbody.innerHTML = '';

        if (entrenadores.length === 0) {
            noData.style.display = 'block';
            return;
        }

        noData.style.display = 'none';
        
        entrenadores.forEach(entrenador => {
            const row = document.createElement('tr');
            
            // Creamos ID √∫nico para el link de descarga de esta fila
            const linkId = `link_${entrenador.dni_ent}`;

            row.innerHTML = `
                <td>${entrenador.dni_ent}</td>
                <td>${entrenador.nombre} ${entrenador.apellido}</td>
                <td>
                    <small>${entrenador.email || '-'}</small><br>
                    <small>${entrenador.telefono || '-'}</small>
                </td>
                <td>
                    <a id="${linkId}" href="#" target="_blank" style="color: #0066ff; text-decoration: none;">
                        üìÑ ${entrenador.archivo_nombre || 'Ver Documento'}
                    </a>
                </td>
                <td>
                    <button type="button" class="btn-eliminar" 
                            onclick="eliminarEntrenador('${entrenador.dni_ent}')">
                        Eliminar
                    </button>
                </td>
            `;
            tbody.appendChild(row);

            // Cargar el BLOB desde IndexedDB para este entrenador
            cargarLinkArchivo(entrenador.dni_ent, linkId);
        });
    }

    function cargarLinkArchivo(dni, elementId) {
        if (!db) return; // Si la DB no carg√≥ aun, salimos

        const dbKey = `entrenador_conducta_${dni}`;
        const transaction = db.transaction([STORE_NAME], "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(dbKey);

        request.onsuccess = () => {
            const blob = request.result;
            const linkElement = document.getElementById(elementId);
            if (blob && linkElement) {
                const url = URL.createObjectURL(blob);
                linkElement.href = url;
            } else if (linkElement) {
                linkElement.style.color = 'red';
                linkElement.textContent = '‚ö†Ô∏è Error al cargar';
                linkElement.onclick = (e) => e.preventDefault();
            }
        };
    }

    function verificarBotonSiguiente() {
        const datosGuardados = cargarDesdeLocalStorage();
        const entrenadores = datosGuardados.entrenadores || [];
        const btn = document.getElementById('btnSiguienteEntrenadores');
        
        if (entrenadores.length > 0) {
            btn.disabled = false;
            btn.classList.remove('btn-siguiente');
            btn.classList.add('btn-aprobar');
        } else {
            btn.disabled = true;
            btn.classList.remove('btn-aprobar');
            btn.classList.add('btn-siguiente');
        }
    }

    function siguientePaso() {
        const datosGuardados = cargarDesdeLocalStorage();
        if (datosGuardados.entrenadores && datosGuardados.entrenadores.length > 0) {
            window.location.href = "{% url 'escuelas:registro_wizard' 'tutores' %}";
        } else {
            showToast('Debe registrar al menos un entrenador', 'error');
        }
    }
</script>
{% endblock %}